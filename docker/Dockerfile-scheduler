FROM php:8.2-fpm-bullseye

# Installer dépendances système et PHP
RUN apt-get update && apt-get install -y git curl unzip \
    && docker-php-ext-install pdo_mysql bcmath sockets pcntl \
    && pecl install redis apcu \
    && docker-php-ext-enable redis apcu

# Copier l’application et crontab
COPY ./api /fleetbase/api
COPY docker/crontab /fleetbase/crontab
COPY .ssm-parent.yaml /fleetbase/.ssm-parent.yaml

WORKDIR /fleetbase/api

# Installer go-crond
RUN curl -L https://github.com/webdevops/go-crond/releases/download/23.12.0/go-crond.linux.amd64 \
    -o /usr/local/bin/go-crond && chmod +x /usr/local/bin/go-crond

# Exposer un port pour que Render considère le service “up” (pas utilisé réellement)
EXPOSE 8080

# Commande de démarrage
CMD sh -c "go-crond --verbose root:/fleetbase/crontab & tail -f /dev/null"
